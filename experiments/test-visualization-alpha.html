<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualization Alpha & Mirror Centering Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: #fff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .description {
      text-align: center;
      margin-bottom: 30px;
      color: #aaa;
    }

    .test-section {
      margin-bottom: 40px;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
    }

    .test-section h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #4CAF50;
    }

    .test-section p {
      margin: 10px 0;
      line-height: 1.6;
    }

    canvas {
      display: block;
      width: 100%;
      max-width: 800px;
      height: 300px;
      margin: 20px auto;
      background: #000;
      border: 2px solid #444;
      border-radius: 4px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px 0;
      padding: 15px;
      background: #333;
      border-radius: 4px;
    }

    .control-group {
      flex: 1;
      min-width: 200px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .control-group input[type="range"] {
      width: 100%;
    }

    .control-group .value {
      display: inline-block;
      margin-left: 10px;
      color: #4CAF50;
      font-family: monospace;
    }

    button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }

    button:hover {
      background: #45a049;
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 3px;
      margin-left: 10px;
      font-size: 12px;
    }

    .status.recording {
      background: #f44336;
    }

    .status.active {
      background: #4CAF50;
    }

    .note {
      background: #444;
      padding: 10px;
      border-left: 4px solid #4CAF50;
      margin: 10px 0;
      font-style: italic;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .comparison-item {
      text-align: center;
    }

    .comparison-item h3 {
      margin: 10px 0;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visualization Alpha & Mirror Centering Test</h1>
    <p class="description">Testing fixes for issue #10: configurable transparency and proper mirror mode centering</p>

    <!-- Test 1: Visualization Alpha -->
    <div class="test-section">
      <h2>Test 1: Configurable Visualization Transparency</h2>
      <p><strong>Issue:</strong> The visualization was always fully opaque, with no way to control transparency.</p>
      <p><strong>Fix:</strong> Added <code>visualizationAlpha</code> option (0-1) to control transparency of the visualization itself (separate from foreground images).</p>

      <canvas id="canvas1"></canvas>

      <div class="controls">
        <div class="control-group">
          <label>
            Visualization Alpha: <span class="value" id="alpha1-value">1.00</span>
          </label>
          <input type="range" id="alpha1" min="0" max="100" value="100" step="1">
        </div>
        <div class="control-group">
          <label>
            Foreground Alpha: <span class="value" id="fg-alpha1-value">1.00</span>
          </label>
          <input type="range" id="fg-alpha1" min="0" max="100" value="100" step="1">
        </div>
      </div>

      <button id="start1">Start Microphone</button>
      <button id="stop1" disabled>Stop Microphone</button>

      <div class="note">
        <strong>How to test:</strong>
        <ol>
          <li>Click "Start Microphone" and allow microphone access</li>
          <li>Adjust "Visualization Alpha" slider to see the waveform become transparent</li>
          <li>Adjust "Foreground Alpha" to control the foreground image transparency separately</li>
          <li>Notice that both sliders work independently</li>
        </ol>
      </div>
    </div>

    <!-- Test 2: Mirror Mode Centering -->
    <div class="test-section">
      <h2>Test 2: Proper Mirror Mode Vertical Centering</h2>
      <p><strong>Issue:</strong> In mirror mode, the bottom edge went beyond the bottom boundary while the top edge did not, causing improper centering.</p>
      <p><strong>Fix:</strong> When mirror mode is enabled, each half now uses only half the amplitude to stay properly centered within the canvas bounds.</p>

      <canvas id="canvas2"></canvas>

      <div class="controls">
        <div class="control-group">
          <label>
            <input type="checkbox" id="mirror2" checked> Enable Mirror Mode
          </label>
        </div>
        <div class="control-group">
          <label>
            Visualization Alpha: <span class="value" id="alpha2-value">1.00</span>
          </label>
          <input type="range" id="alpha2" min="0" max="100" value="100" step="1">
        </div>
      </div>

      <button id="start2">Start Microphone</button>
      <button id="stop2" disabled>Stop Microphone</button>

      <div class="note">
        <strong>How to test:</strong>
        <ol>
          <li>Click "Start Microphone" and make some noise</li>
          <li>Observe that the waveform is perfectly centered vertically</li>
          <li>Toggle mirror mode on/off and verify both modes stay centered</li>
          <li>In mirror mode, verify that neither the top nor bottom edges exceed canvas boundaries</li>
        </ol>
      </div>
    </div>

    <!-- Test 3: Microphone Disconnect Freeze Fix -->
    <div class="test-section">
      <h2>Test 3: Visualization Clears on Microphone Disconnect</h2>
      <p><strong>Issue:</strong> When microphone was disconnected, visualization froze in its last state.</p>
      <p><strong>Fix:</strong> Audio data is now cleared to silence when disconnecting, preventing the freeze.</p>

      <canvas id="canvas3"></canvas>

      <div class="controls">
        <div class="control-group">
          <label>
            Visualization Alpha: <span class="value" id="alpha3-value">0.70</span>
          </label>
          <input type="range" id="alpha3" min="0" max="100" value="70" step="1">
        </div>
      </div>

      <button id="start3">Start Microphone</button>
      <button id="stop3" disabled>Stop Microphone</button>

      <div class="note">
        <strong>How to test:</strong>
        <ol>
          <li>Click "Start Microphone" and make some noise to create visualization movement</li>
          <li>Click "Stop Microphone" while the visualization is active</li>
          <li>Verify that the visualization immediately resets to a flat line (silence)</li>
          <li>The waveform should NOT freeze in its last animated state</li>
        </ol>
      </div>
    </div>
  </div>

  <script type="module">
    import { AudioRecorder } from '../dist/index.js';
    import { WaveformVisualizer } from '../dist/visualizers/WaveformVisualizer.js';

    // Test 1: Visualization Alpha
    let recorder1;
    const canvas1 = document.getElementById('canvas1');
    const start1 = document.getElementById('start1');
    const stop1 = document.getElementById('stop1');
    const alpha1 = document.getElementById('alpha1');
    const alpha1Value = document.getElementById('alpha1-value');
    const fgAlpha1 = document.getElementById('fg-alpha1');
    const fgAlpha1Value = document.getElementById('fg-alpha1-value');

    // Create a test foreground image
    const fgImage1 = new Image();
    fgImage1.src = 'data:image/svg+xml,' + encodeURIComponent(`
      <svg width="800" height="300" xmlns="http://www.w3.org/2000/svg">
        <text x="400" y="150" font-size="48" fill="white" text-anchor="middle" dominant-baseline="middle" opacity="0.8">
          FOREGROUND OVERLAY
        </text>
      </svg>
    `);

    start1.onclick = async () => {
      try {
        const visualizer = new WaveformVisualizer({
          primaryColor: '#00ff88',
          secondaryColor: '#0088ff',
          visualizationAlpha: parseFloat(alpha1.value) / 100,
          foregroundImage: fgImage1,
          foregroundAlpha: parseFloat(fgAlpha1.value) / 100
        });

        recorder1 = new AudioRecorder({
          canvas: canvas1,
          visualizer,
          visualizerOptions: {
            primaryColor: '#00ff88',
            secondaryColor: '#0088ff',
            visualizationAlpha: parseFloat(alpha1.value) / 100,
            foregroundImage: fgImage1,
            foregroundAlpha: parseFloat(fgAlpha1.value) / 100
          }
        });

        await recorder1.startMicrophone();
        start1.disabled = true;
        stop1.disabled = false;
      } catch (err) {
        alert('Microphone error: ' + err.message);
      }
    };

    stop1.onclick = () => {
      if (recorder1) {
        recorder1.disconnect();
        start1.disabled = false;
        stop1.disabled = true;
      }
    };

    alpha1.oninput = () => {
      const value = parseFloat(alpha1.value) / 100;
      alpha1Value.textContent = value.toFixed(2);
      if (recorder1) {
        recorder1.setVisualizerOptions({ visualizationAlpha: value });
      }
    };

    fgAlpha1.oninput = () => {
      const value = parseFloat(fgAlpha1.value) / 100;
      fgAlpha1Value.textContent = value.toFixed(2);
      if (recorder1) {
        recorder1.setVisualizerOptions({ foregroundAlpha: value });
      }
    };

    // Test 2: Mirror Mode Centering
    let recorder2;
    const canvas2 = document.getElementById('canvas2');
    const start2 = document.getElementById('start2');
    const stop2 = document.getElementById('stop2');
    const mirror2 = document.getElementById('mirror2');
    const alpha2 = document.getElementById('alpha2');
    const alpha2Value = document.getElementById('alpha2-value');

    start2.onclick = async () => {
      try {
        const visualizer = new WaveformVisualizer({
          primaryColor: '#ff0088',
          secondaryColor: '#ff8800',
          mirror: mirror2.checked,
          visualizationAlpha: parseFloat(alpha2.value) / 100,
          lineWidth: 3
        });

        recorder2 = new AudioRecorder({
          canvas: canvas2,
          visualizer,
          visualizerOptions: {
            primaryColor: '#ff0088',
            secondaryColor: '#ff8800',
            mirror: mirror2.checked,
            visualizationAlpha: parseFloat(alpha2.value) / 100,
            lineWidth: 3
          }
        });

        await recorder2.startMicrophone();
        start2.disabled = true;
        stop2.disabled = false;
      } catch (err) {
        alert('Microphone error: ' + err.message);
      }
    };

    stop2.onclick = () => {
      if (recorder2) {
        recorder2.disconnect();
        start2.disabled = false;
        stop2.disabled = true;
      }
    };

    mirror2.onchange = () => {
      if (recorder2) {
        recorder2.setVisualizerOptions({ mirror: mirror2.checked });
      }
    };

    alpha2.oninput = () => {
      const value = parseFloat(alpha2.value) / 100;
      alpha2Value.textContent = value.toFixed(2);
      if (recorder2) {
        recorder2.setVisualizerOptions({ visualizationAlpha: value });
      }
    };

    // Test 3: Microphone Disconnect
    let recorder3;
    const canvas3 = document.getElementById('canvas3');
    const start3 = document.getElementById('start3');
    const stop3 = document.getElementById('stop3');
    const alpha3 = document.getElementById('alpha3');
    const alpha3Value = document.getElementById('alpha3-value');

    start3.onclick = async () => {
      try {
        const visualizer = new WaveformVisualizer({
          primaryColor: '#8800ff',
          secondaryColor: '#00ffff',
          mirror: true,
          visualizationAlpha: parseFloat(alpha3.value) / 100,
          lineWidth: 2
        });

        recorder3 = new AudioRecorder({
          canvas: canvas3,
          visualizer,
          visualizerOptions: {
            primaryColor: '#8800ff',
            secondaryColor: '#00ffff',
            mirror: true,
            visualizationAlpha: parseFloat(alpha3.value) / 100,
            lineWidth: 2
          }
        });

        await recorder3.startMicrophone();
        start3.disabled = true;
        stop3.disabled = false;
      } catch (err) {
        alert('Microphone error: ' + err.message);
      }
    };

    stop3.onclick = () => {
      if (recorder3) {
        recorder3.disconnect();
        start3.disabled = false;
        stop3.disabled = true;
      }
    };

    alpha3.oninput = () => {
      const value = parseFloat(alpha3.value) / 100;
      alpha3Value.textContent = value.toFixed(2);
      if (recorder3) {
        recorder3.setVisualizerOptions({ visualizationAlpha: value });
      }
    };
  </script>
</body>
</html>
